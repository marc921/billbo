BillBo is a usage-based billing engine API. See `README.md` for product context and lexicon.

---

# Project Structure

```
billbo/
├── magefile.go                              # Mage targets (local commands)
├── docker-compose.yml                       # PostgreSQL container
├── backend/
│   ├── api/                                 # HTTP API handlers
│   │   └── ingest/                          # Ingest API (events)
│   ├── cmd/                                 # Entrypoints
│   │   └── ingest-api/                      # Ingest API server
│   └── database/                            # Database layer
│       ├── migrations/                      # dbmate migration files
│       ├── queries/                         # sqlc query files
│       ├── sqlcgen/                         # Generated code (DO NOT EDIT)
│       ├── schema.sql                       # Generated schema (DO NOT EDIT)
│       ├── sqlc.yaml                        # sqlc configuration
│       └── postgres.go                      # Connection pool setup
└── frontend/
    └── src/
        ├── api/                             # API callers (typed fetch wrappers)
        ├── components/                      # React component tree
        │   └── *Page/                       # Page components
        ├── queries/                         # React Query hooks
        ├── routes.tsx                       # Route definitions
        ├── App.tsx                          # App root (Router, QueryClient)
        └── main.tsx                         # Entry point
```

---

# Local Development

All local commands use [mage](https://magefile.org/). Run `mage -l` to list available targets.

```bash
mage startDB       # Start postgres container + run migrations
mage stopDB        # Stop postgres container
mage resetDB       # Drop and recreate database + run migrations
mage ingestAPI     # Start the ingest API server (port 8080)
mage frontend      # Start the frontend dev server (port 5173)
mage generate      # Run sqlc code generation
```

**Typical workflow:**
```bash
mage startDB
mage ingestAPI     # in one terminal
mage frontend      # in another terminal
```

The Vite dev server proxies `/api` requests to the backend at `localhost:8080`.

---

# Backend

## Standards and Patterns

- Go with [Echo](https://echo.labstack.com/) web framework
- Structured logging with [zap](https://github.com/uber-go/zap)
- Configuration via environment variables using [go-envconfig](https://github.com/sethvargo/go-envconfig)
- Use `fmt.Errorf("funcName: %w", err)` to wrap errors with context

## Database

- PostgreSQL, managed via Docker Compose
- [dbmate](https://github.com/amacneil/dbmate) for migrations
- [sqlc](https://sqlc.dev/) for type-safe Go code generation from SQL queries
- Connection pool via [pgxpool](https://github.com/jackc/pgx) (pgx/v5)

### Generated Files

**NEVER edit directly:**
- `backend/database/schema.sql` — generated by dbmate
- `backend/database/sqlcgen/*` — generated by sqlc

### Migration vs Feature Code

A migration commit contains only schema changes:
- Migration SQL file (DDL: `CREATE TABLE`, `ALTER TABLE`, etc.)
- Regenerated `schema.sql` and `sqlcgen/` files

SQL queries belong in feature commits, not migration commits. Queries define *how* you use the schema, not *what* the schema is.

### Adding a New Migration

1. Create a new file in `backend/database/migrations/` with format `YYYYMMDDHHMMSS_description.sql`
2. Use `-- migrate:up` and `-- migrate:down` sections
3. Run `mage startDB` to apply (or `mage resetDB` to recreate from scratch)
4. Run `mage generate` to regenerate sqlc code

### sqlc Query Guidelines

- Put queries in `backend/database/queries/`, one file per domain
- Use sqlc annotations: `-- name: QueryName :one`, `:many`, `:exec`
- Use `sqlc.narg()` for nullable fields

---

# Frontend

## Standards and Patterns

- React 19 with TypeScript (strict mode)
- [Vite](https://vite.dev/) with SWC for fast builds
- [Tailwind CSS](https://tailwindcss.com/) for styling
- [React Router DOM](https://reactrouter.com/) v6 for routing
- [TanStack React Query](https://tanstack.com/query) for data fetching
- Use `type`, never `interface`
- Path alias: `@/` maps to `frontend/src/`

## Type Checking

```bash
cd frontend && npx tsc -b
```

The project should always compile. Verify after changes.

## API Layer

Use the generic typed API caller factories from `src/api/generic.ts`:
- `makeApiGet<Query, Output, Path>(path)` for GET requests
- `makeApiPost<Body, Output, Path>(path)` for POST requests

Group API callers by domain in `src/api/` (e.g., `events.ts`).

## React Query Hooks

Put query hooks in `src/queries/`, one file per hook (e.g., `useListEvents.ts`).

## Routing

Routes are defined as a typed dictionary in `src/routes.tsx`. Add new pages there. Page components live in `src/components/*Page/`.

## Component Patterns

- Prefer flexbox for layout. Explicit `flex-row` or `flex-col` every time you use `flex`. Use `gap-` to space elements.
- Extract custom hooks when component logic becomes complex
- Avoid useEffect for triggering actions; prefer direct callbacks